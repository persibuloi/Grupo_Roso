<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Completo - Login</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            padding: 12px 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .btn:hover {
            background: #1d4ed8;
        }
        .btn-green { background: #059669; }
        .btn-green:hover { background: #047857; }
        .btn-orange { background: #ea580c; }
        .btn-orange:hover { background: #c2410c; }
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { background: #d1fae5; color: #059669; border: 1px solid #059669; }
        .error { background: #fee2e2; color: #dc2626; border: 1px solid #dc2626; }
        .info { background: #e0f2fe; color: #0369a1; border: 1px solid #0369a1; }
        .warning { background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }
        .step {
            background: #f8fafc;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #2563eb;
            border-radius: 4px;
        }
        .step h4 {
            margin: 0 0 10px 0;
            color: #1e40af;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico Completo del Login</h1>
        <p>Vamos a probar cada componente paso a paso para encontrar exactamente d√≥nde est√° el problema.</p>

        <div class="step">
            <h4>Paso 1: Variables de Entorno</h4>
            <button onclick="checkEnvironment()" class="btn">üîß Verificar Variables</button>
            <div id="envResult" class="result" style="display: none;"></div>
        </div>

        <div class="step">
            <h4>Paso 2: Conexi√≥n Directa a Supabase</h4>
            <button onclick="testSupabaseConnection()" class="btn btn-green">üîó Probar Conexi√≥n</button>
            <div id="connectionResult" class="result" style="display: none;"></div>
        </div>

        <div class="step">
            <h4>Paso 3: Verificar Usuarios en Base de Datos</h4>
            <button onclick="checkUsersInDB()" class="btn btn-orange">üë• Ver Usuarios</button>
            <div id="usersResult" class="result" style="display: none;"></div>
        </div>

        <div class="step">
            <h4>Paso 4: Probar Hash de Contrase√±a</h4>
            <input type="text" id="testPassword" placeholder="Escribe: admin123" style="padding: 8px; margin: 5px;">
            <button onclick="testPasswordHash()" class="btn">üîê Generar Hash</button>
            <div id="hashResult" class="result" style="display: none;"></div>
        </div>

        <div class="step">
            <h4>Paso 5: Login Completo</h4>
            <input type="email" id="loginEmail" placeholder="admin@gruporosso.com" style="padding: 8px; margin: 5px; width: 200px;">
            <input type="password" id="loginPassword" placeholder="admin123" style="padding: 8px; margin: 5px; width: 150px;">
            <button onclick="testFullLogin()" class="btn btn-green">üîë Test Login</button>
            <div id="loginResult" class="result" style="display: none;"></div>
        </div>

        <div class="step">
            <h4>Paso 6: Diagn√≥stico Autom√°tico</h4>
            <button onclick="runFullDiagnostic()" class="btn" style="background: #7c3aed;">üöÄ Ejecutar Diagn√≥stico Completo</button>
            <div id="diagnosticResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Paso 1: Verificar variables de entorno
        async function checkEnvironment() {
            const resultDiv = document.getElementById('envResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'Verificando variables de entorno...\n';
            
            try {
                const response = await fetch('/api/debug/env');
                const data = await response.json();
                
                resultDiv.textContent += `Status: ${response.status}\n`;
                resultDiv.textContent += `Variables:\n${JSON.stringify(data, null, 2)}\n`;
                
                if (data.env_check.SUPABASE_URL === 'CONFIGURADO' && data.env_check.SUPABASE_SERVICE_ROLE_KEY === 'CONFIGURADO') {
                    resultDiv.className = 'result success';
                    resultDiv.textContent += '\n‚úÖ Variables de entorno OK';
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent += '\n‚ùå Variables de entorno FALTANTES';
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent += `\nüí• Error: ${error.message}`;
            }
        }

        // Paso 2: Probar conexi√≥n directa
        async function testSupabaseConnection() {
            const resultDiv = document.getElementById('connectionResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'Probando conexi√≥n directa a Supabase...\n';
            
            try {
                const response = await fetch('/api/users');
                const data = await response.json();
                
                resultDiv.textContent += `Status: ${response.status}\n`;
                resultDiv.textContent += `Response: ${JSON.stringify(data, null, 2)}\n`;
                
                if (response.ok && data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent += `\n‚úÖ Conexi√≥n OK - ${data.users.length} usuarios encontrados`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent += `\n‚ùå Error de conexi√≥n: ${data.error || 'Unknown'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent += `\nüí• Error: ${error.message}`;
            }
        }

        // Paso 3: Ver usuarios en DB
        async function checkUsersInDB() {
            const resultDiv = document.getElementById('usersResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'Obteniendo usuarios de la base de datos...\n';
            
            try {
                const response = await fetch('/api/users');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    resultDiv.textContent += `Total usuarios: ${data.users.length}\n\n`;
                    
                    data.users.forEach(user => {
                        resultDiv.textContent += `Email: ${user.email}\n`;
                        resultDiv.textContent += `Rol: ${user.role}\n`;
                        resultDiv.textContent += `Activo: ${user.active}\n`;
                        resultDiv.textContent += `Hash: ${user.password_hash || user.password}\n`;
                        resultDiv.textContent += `---\n`;
                    });
                    
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent += `‚ùå Error: ${data.error}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent += `üí• Error: ${error.message}`;
            }
        }

        // Paso 4: Probar hash
        async function testPasswordHash() {
            const password = document.getElementById('testPassword').value || 'admin123';
            const resultDiv = document.getElementById('hashResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            
            try {
                const hash = await generateHash(password);
                resultDiv.textContent = `Contrase√±a: "${password}"\n`;
                resultDiv.textContent += `Hash generado: ${hash}\n\n`;
                resultDiv.textContent += `Hash esperado para admin123:\n7ecd13d8cb7dd26c8c816fd571971e59996d4c5523d656e80ccf037ec4878a4ac\n\n`;
                
                if (password === 'admin123' && hash === '7ecd13d8cb7dd26c8c816fd571971e59996d4c5523d656e80ccf037ec4878a4ac') {
                    resultDiv.className = 'result success';
                    resultDiv.textContent += '‚úÖ Hash correcto para admin123';
                } else {
                    resultDiv.className = 'result warning';
                    resultDiv.textContent += '‚ö†Ô∏è Hash diferente - verifica la funci√≥n de hash';
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `üí• Error: ${error.message}`;
            }
        }

        // Paso 5: Login completo
        async function testFullLogin() {
            const email = document.getElementById('loginEmail').value || 'admin@gruporosso.com';
            const password = document.getElementById('loginPassword').value || 'admin123';
            const resultDiv = document.getElementById('loginResult');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = `Probando login completo...\n`;
            resultDiv.textContent += `Email: ${email}\n`;
            resultDiv.textContent += `Password: ${password}\n\n`;
            
            try {
                const response = await fetch('/api/auth/simple-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                resultDiv.textContent += `Status: ${response.status}\n`;
                resultDiv.textContent += `Response: ${JSON.stringify(data, null, 2)}\n`;
                
                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent += `\n‚úÖ LOGIN EXITOSO!\n`;
                    resultDiv.textContent += `Usuario: ${data.user.name}\n`;
                    resultDiv.textContent += `Rol: ${data.user.role}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent += `\n‚ùå LOGIN FALL√ì: ${data.error}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent += `\nüí• Error: ${error.message}`;
            }
        }

        // Paso 6: Diagn√≥stico completo
        async function runFullDiagnostic() {
            const resultDiv = document.getElementById('diagnosticResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'üöÄ Ejecutando diagn√≥stico completo...\n\n';
            
            // Ejecutar todos los tests
            await checkEnvironment();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testSupabaseConnection();
            await new Promise(resolve => setTimeout(resolve, 500));
            await checkUsersInDB();
            await new Promise(resolve => setTimeout(resolve, 500));
            document.getElementById('testPassword').value = 'admin123';
            await testPasswordHash();
            await new Promise(resolve => setTimeout(resolve, 500));
            document.getElementById('loginEmail').value = 'admin@gruporosso.com';
            document.getElementById('loginPassword').value = 'admin123';
            await testFullLogin();
            
            resultDiv.textContent += '‚úÖ Diagn√≥stico completo ejecutado.\n';
            resultDiv.textContent += 'Revisa los resultados de cada paso arriba.';
            resultDiv.className = 'result success';
        }

        // Funci√≥n auxiliar para generar hash
        async function generateHash(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password + 'grupo-rosso-2024');
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
    </script>
</body>
</html>
